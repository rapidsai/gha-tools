#!/bin/bash
# A utility script that generates a package name from a package type
# Positional Arguments:
#   1) package type
#   2) repo_name (optional): overrides repo name derived from RAPIDS_REPOSITORY
# Flags:
#   --pure: treats conda_python as noarch and wheel_python as pure
#   --stable: package uses the Python limited API
#   --cuda [version]: appends CUDA suffix processed by rapids-wheel-ctk-name-gen
#                     if no version provided, uses RAPIDS_CUDA_VERSION
set -euo pipefail
export RAPIDS_SCRIPT_NAME="rapids-package-name"

is_pure_flag=0
cuda_flag=0
stable_flag=0
cuda_version=""
pkg_type=""
repo_name=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --pure)
      is_pure_flag=1
      shift
      ;;
    --stable)
      stable_flag=1
      shift
      ;;
    --cuda)
      cuda_flag=1
      shift
      # Check if next argument exists and doesn't start with "-" (i.e., it's a version)
      if [[ $# -gt 0 && "$1" != -* ]]; then
        cuda_version="$1"
        shift
      else
        # No argument provided, will use RAPIDS_CUDA_VERSION
        cuda_version=""
      fi
      ;;
    -*)
      rapids-echo-stderr "Unknown flag: $1. Supported flags: --pure, --stable, --cuda"
      exit 1
      ;;
    *)
      # Handle positional arguments - first is required pkg_type, second is optional repo_name
      if [[ -z "${pkg_type}" ]]; then
        pkg_type="$1"
        shift
      elif [[ -z "${repo_name}" ]]; then
        repo_name="$1"
        shift
      else
        rapids-echo-stderr "Too many positional arguments: $1"
        exit 1
      fi
      ;;
  esac
done

# Error checking
if [[ -z "${pkg_type}" ]]; then
  rapids-echo-stderr "Must specify input arguments: PKG_TYPE [REPO_NAME] [--pure] [--stable] [--cuda [version]]"
  exit 1
fi

if (( stable_flag == 1)) && (( is_pure_flag == 1)); then
  rapids-echo-stderr "Cannot use '--pure' with '--stable', you must choose one or the other"
  exit 1
fi

if (( stable_flag == 1)) && [[ $pkg_type == "conda_cpp" || $pkg_type == "wheel_cpp" ]]; then
  rapids-echo-stderr "'--stable' is only compatible with Python package builds"
  exit 1
fi

# Set repo_name to default from RAPIDS_REPOSITORY if not provided as argument
if [[ -z "${repo_name}" ]]; then
  repo_name="${RAPIDS_REPOSITORY##*/}"
fi

# TODO: once `RAPIDS_PY_WHEEL_PURE` is removed, these flags can be collapsed
# into a single variable `is_pure`.
# Set flags based on --pure flag or existing environment variable
is_pure_conda=0
is_pure_wheel=0

if (( is_pure_flag == 1 )); then
  is_pure_conda=1
  is_pure_wheel=1
fi

# TODO: remove support for this enviroment variable once all RAPIDS repos have
# been updated to pass CLI flags directly.
if [[ "${RAPIDS_PY_WHEEL_PURE:-}" == "1" ]]; then
  is_pure_wheel=1
fi

# Check for RAPIDS_PY_NOARCH_SUFFIX override for conda_python packages
use_custom_conda_name=0
if [[ -n "${RAPIDS_PY_NOARCH_SUFFIX:-}" ]] && [[ "${pkg_type}" == "conda_python" ]]; then
  use_custom_conda_name=1
fi

append_cuda=0
append_wheelname=0
append_pyver=0
append_arch=0
append_noarch=0
append_stable=0

case "${pkg_type}" in
  conda_cpp)
    append_cuda=1
    append_arch=1
    ;;
  conda_python)
    # Pure conda packages do not need cuda, python version, or arch appended
    if (( is_pure_conda == 0 )); then
      append_cuda=1
      append_pyver=1
      append_arch=1
    else
      append_noarch=1
    fi
    if (( stable_flag == 1 )); then
      append_stable=1
      append_cuda=0
      append_pyver=0
    fi
    ;;
  wheel_cpp)
    append_wheelname=1
    append_arch=1
    ;;
  wheel_python)
    append_wheelname=1
    # Pure wheels do not need a pyver or arch
    if (( is_pure_wheel == 0 )); then
      append_pyver=1
      append_arch=1
    fi
    if (( stable_flag == 1 )); then
      append_stable=1
      append_pyver=0
    fi
    ;;
  *)
    rapids-echo-stderr "Nonstandard package type '${pkg_type}'"
    exit 1
    ;;
esac

pkg_name="${pkg_type}"

# If RAPIDS_PY_NOARCH_SUFFIX is set for conda_python, use custom name and skip all other naming
if (( use_custom_conda_name == 1 )); then
  pkg_name+="_${RAPIDS_PY_NOARCH_SUFFIX}"
  # Skip to the end - set all append flags to 0
  append_cuda=0
  append_wheelname=0
  append_pyver=0
  append_arch=0
  append_noarch=0
  append_stable=0
fi

# for conda package types, append CUDA version
if (( append_cuda == 1 )); then
  pkg_name+="_cuda${RAPIDS_CUDA_VERSION%%.*}"
fi

# for wheels, add the python wheel name if env var is set
if (( append_wheelname )) && [[ -v RAPIDS_PY_WHEEL_NAME ]] && [[ "${RAPIDS_PY_WHEEL_NAME}" != "" ]]; then
  pkg_name+="_${RAPIDS_PY_WHEEL_NAME}"
fi

# for python package types (except pure wheels), add pyver
if (( append_pyver == 1 )); then
  pkg_name+="_py${RAPIDS_PY_VERSION//./}"
fi

# for cpp and python wheels, append `abi3`
if (( append_stable == 1)); then
  pkg_name+="_abi3"
fi

# for cpp and python package types (except pure wheels), append the arch of the host that's running the upload command
if (( append_arch == 1)); then
  pkg_name+="_$(arch)"
fi

# for conda python packages that are `noarch: python`  builds
if (( append_noarch == 1 )); then
  pkg_name+="_noarch"
fi

# if --cuda flag is used, process the version and append to package name
if (( cuda_flag == 1 )); then
  # Use provided version or fall back to RAPIDS_CUDA_VERSION
  if [[ -z "${cuda_version}" ]]; then
    if [[ -z "${RAPIDS_CUDA_VERSION:-}" ]]; then
      rapids-echo-stderr "RAPIDS_CUDA_VERSION environment variable must be set when using --cuda without version argument"
      exit 1
    fi
    cuda_version="${RAPIDS_CUDA_VERSION}"
  fi
  # Process the CUDA version through rapids-wheel-ctk-name-gen
  cuda_suffix=$(rapids-wheel-ctk-name-gen "${cuda_version}")
  pkg_name+="_${cuda_suffix}"
fi

pkg_name="${repo_name}_${pkg_name}"

echo -n "${pkg_name}"
