#!/bin/bash
# Wraps arbitrary commands with arbitrary args. Emits an OpenTelemetry span for tracing the command
#
# To add metadata tags (attrs), set (or append to) the RAPIDS_OTEL_ATTRS str.
# See https://github.com/equinix-labs/otel-cli?tab=readme-ov-file#header-and-attribute-formatting for details
#
#

TIME_FORMAT="--rfc-3339=ns"

# this cleanly sets up a tempdir for the fifo that we use to pass data out from subshell into our currrent one
# https://unix.stackexchange.com/a/29918/34459
tmpdir=
cleanup () {
  trap - EXIT
  if [ -n "$tmpdir" ] ; then rm -rf "$tmpdir"; fi
  if [ -n "$1" ]; then trap - $1; kill -$1 $$; fi
}
tmpdir=$(mktemp -d)
trap 'cleanup' EXIT
trap 'cleanup HUP' HUP
trap 'cleanup TERM' TERM
trap 'cleanup INT' INT
mkfifo "$tmpdir/pipe"
mkfifo "$tmpdir/status_pipe"

start=$(date ${TIME_FORMAT});

if [[ $(type otel-cli >/dev/null 2>&1) -eq 0 ]]; then
    echo "Running command with OpenTelemetry instrumentation";
    (
        set -x
        opentelemetry-instrument \
            --service_name ${RAPIDS_OTEL_SERVICE_NAME:-"rapids-build-test"} \
            --traces_exporter ${RAPIDS_OTEL_TRACES_EXPORTER:-"console"} \
            --metrics_exporter ${RAPIDS_OTEL_METRICS_EXPORTER:-"console"} \
            --logs_exporter ${RAPIDS_OTEL_LOGS_EXPORTER:-"console"} \
            --exporter_otlp_traces_endpoint ${OTEL_EXPORTER_OTLP_TRACES_ENDPOINT} \
            --exporter_otlp_metrics_endpoint ${OTEL_EXPORTER_OTLP_METRICS_ENDPOINT} \
            --exporter_otlp_logs_endpoint ${OTEL_EXPORTER_OTLP_LOGS_ENDPOINT} \
            --exporter_otlp_protocol http/protobuf \
            "$@" 2>&1 > $tmpdir/pipe;
        echo $? > $tmpdir/status_pipe;
        set +x
    ) &
else
    echo "Skipping instrumentation, running \"${@}\"";
    (
        "$@" 2>&1 > $tmpdir/pipe;
        echo $? > $tmpdir/status_pipe;
    ) &
fi

set +x
echo "stdout/stderr from command:"
while IFS= read -r line; do
    echo "$line"
done < $tmpdir/pipe
RETURN_STATUS=$(<$tmpdir/status_pipe)
set -x

# Trim leading commas from RAPIDS_OTEL_ATTRS from clumsy concatentation
RAPIDS_OTEL_ATTRS=$(echo "${RAPIDS_OTEL_ATTRS}" | sed 's/,$//')

type otel-cli >/dev/null 2>&1 && {
    if [ -n "${RAPIDS_OTEL_ATTRS}" ]; then  \
        attrs="--attrs ${RAPIDS_OTEL_ATTRS}"; \
    fi
    otel-cli span -n "$1" -s "${RAPIDS_JOB_ID}" \
        --start "$start" --end "$(date ${TIME_FORMAT})" \
        --status-code ${RETURN_STATUS} \
        ${attrs}
}
exit ${RETURN_STATUS}
